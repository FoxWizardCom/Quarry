{% extends 'base.html.twig' %}

{% block title %}Quarry!{% endblock %}
{% block stylesheets %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css">
    <link rel="stylesheet" href="{{ asset('assets/css/story.css') }}" />
    <script src="https://unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
    <script src="{{ asset('bundles/fosjsrouting/js/router.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>
{% endblock %}

{% block body %}
    <div id="showDetail">-</div>
    <div id='map'></div>
    <div id="detail" class="overlay-open">
        <div id="story" class="story" style="background-color:{{ story.color }}; color:{{ story.textColor }};">
            <p class="title">{{ story.title }}</p>
            <div class="content">{{ story.content }}</div>
            <ul id="chapters{{ story.id }}">
                {% for chapter in story.chapters %}
                    <li>
                        <div id="chapter{{ chapter.id }}" class="chapter hidden" style="background-color:{{ chapter.color }}; color:{{ chapter.textColor }};">
                            <p class="title">Chapter {{ chapter.number }}: {{ chapter.title }}</p>
                            <p>{{ chapter.content }}</p>
                            <button class="startChapter" data-chapter="{{ chapter.id }}">Start Chapter</button>
                            <ul>
                                {% for mission in chapter.missions %}
                                    <li>
                                    <div id="mission{{ mission.id }}" data-chapter="{{ chapter.id }}" class="mission hidden" style="background-color:{{ mission.color }}; color:{{ mission.textColor }};">
                                        <p class="title">Mission {{ mission.number }}: {{ mission.title }}</p>
                                        <p>{{ mission.content }}</p>
                                        <button class="startMission" data-chapter="{{ chapter.id }}" data-mission="{{ mission.id }}">Start Mission</button>
                                        <ul>
                                            {% for checkpoint in mission.checkpoints %}
                                                <li>
                                                    <div id="checkpoint{{ checkpoint.id }}" data-chapter="{{ chapter.id }}" data-mission="{{ mission.id }}" class="checkpoint hidden" style="background-color:{{ checkpoint.color }}; color:{{ checkpoint.textColor }};">
                                                        <p class="title">Checkpoint {{ checkpoint.number }}: {{ checkpoint.title }}</p>
                                                        <p>{{ checkpoint.content }}</p>
                                                        <button class="startCheckpoint" data-chapter="{{ chapter.id }}" data-mission="{{ mission.id }}" data-checkpoint="{{ checkpoint.id }}">Start Checkpoint</button>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                        </li>
                                {% endfor %}
                        </ul>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <button class="startStory"></button>
    </div>
    <script>

      var progressions = [];

        function convertProgression(){
            {% for progression in progressions %}
                progressions.push({
                        userStoryId: {{ progression.userStory.id }},
                        id: {{  progression.id }},
                        chapterId: {{ progression.chapter }},
                        missionId: {% if progression.mission %}{{ progression.mission }} {% else %} 0 {% endif %},
                        checkpointId: {% if progression.checkpoint %}{{ progression.checkpoint }} {% else %} 0 {% endif %},
                        timeStarted: {{ progression.timeStarted }},
                        timeFinished: {{ progression.timeFinished }} });
            {% endfor %}
        }

        function startStory(){
            if(progressions[0].timeStarted == 0){
                progressions[0].timeStarted = new Date().getTime();
                saveProgression(progressions[0]);
            }
            else{
                saveProgression(progressions[0]);
                setupStoryFromProgression();
            }
        }

      function setupStoryFromProgression(){
          for(var i = 0; i < progressions.length; i++){
              var progression = progressions[i];

              if(progression.timeStarted != 0 && progression.timeFinished == 0){
                  alert('should add chapter' + progression.chapterId);
                  $('#chapter'+ progression.chapterId ).removeClass('hidden');
              }
          }

          $('.startChapter').on('click', function(){

          });
      }

        function setupMap() {
            var map = L.map('map').fitWorld();

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.pencil',
                accessToken: 'pk.eyJ1IjoiZm94d2l6YXJkIiwiYSI6ImNpdjd5a3I3ZTAwMG0yb255NHN5b2NyajgifQ.PmTe7X9ZZGrmIXaN5vJoeg'
            }).addTo(map);

            function Mission(title, content, location, radius, color, type) {
                this.title = title;
                this.content = content;
                this.location = location;
                this.radius = radius;
                this.color = color;
                this.type = type;
            }

            var mission = new Mission("Mission 1", "C'est ici que commencera votre premiere mission", [50.848375, 4.350823], 500, 'red', 0);

            if (mission.type == 0) {
                var circle = L.circle(mission.location, mission.radius, {
                    color: mission.color,
                    fillColor: '#f03',
                    fillOpacity: 0.5
                }).addTo(map).bindPopup(mission.content);
            }

            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);
            map.locate({setView: true, maxZoom: 16});
        }

        function onLocationFound(e) {
            var radius = e.accuracy / 20;

            L.marker(e.latlng).addTo(map)
                    .bindPopup("You are within " + radius + " meters from this point").openPopup();

            L.circle(e.latlng, radius).addTo(map);
        }

        function onLocationError(e) {
            alert(e.message);
        }

        function saveProgression(progression){
            $.ajax({
                type: "POST",
                url: Routing.generate('ajax'),
                dataType: "json",
//                data: "{progression: " + progression + "}",
                data: '{' +
                    '"id":' + progression.id +
                    ', "timeStarted":' + progression.timeStarted +
                    ', "timeFinished":' + progression.timeFinished + "}",
                success: function(response) {
                    console.log(response);
                }
            });
        }

        jQuery(document).ready(function(){

            convertProgression();
            setupMap();
            startStory();

            var detail = $('#detail');

            $('#showDetail').on('click', function() {
                console.log("button clicked");
                if (detail.hasClass('overlay-open')){
                    detail.removeClass('overlay-open');
                    detail.addClass('overlay-closed');
                    $(this).text("+")
               }else{
                    detail.addClass('overlay-open');
                    detail.removeClass('overlay-closed');
                    $(this).text("-")
                }
            });

            $('#addchapter').on('click', function(){

            });

            $('#ajax').on('click', function(){
                $.ajax({
                    type: "POST",
                    url: Routing.generate('ajax'),
                    dataType: "json",
                    data: "",
                    success: function(response) {
                        console.log(response);
                    }
                });
            });
        });
    </script>
{% endblock %}